<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Com Dot KKH - 2FA TOTP Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css">
  <!-- Google Fonts -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource-variable/montserrat@5.0.14/index.min.css">
  <style>
    body {
      font-family: 'Montserrat Variable', 'Montserrat', Arial, sans-serif;
      background: radial-gradient(circle, #031442 0%, #130537 100%);
      min-height: 100vh;
    }
    .totp-cube {
      width: 140px;
      height: 140px;
      perspective: 700px;
      margin: auto;
    }
    .cube {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      animation: rotateCube 3.5s infinite linear;
    }
    .cube-face {
      position: absolute;
      width: 140px;
      height: 140px;
      background: linear-gradient(135deg, #7f5cff 70%, #45e2ff 100%);
      opacity: 0.97;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 2.5rem;
      border-radius: 18px;
      border: 3px solid #ffeffd88;
      box-shadow: 0 8px 24px #0ff2db46, 0 2px 6px #20004e44;
      font-weight: 800;
      letter-spacing: 0.12em;
      user-select: none;
      transition: background 0.2s;
    }
    .cube-face.front  { transform: rotateY(0deg)        translateZ(70px);}
    .cube-face.back   { transform: rotateY(180deg)      translateZ(70px);}
    .cube-face.right  { transform: rotateY(90deg)       translateZ(70px);}
    .cube-face.left   { transform: rotateY(-90deg)      translateZ(70px);}
    .cube-face.top    { transform: rotateX(90deg)       translateZ(70px);}
    .cube-face.bottom { transform: rotateX(-90deg)      translateZ(70px);}
    @keyframes rotateCube {
      0% { transform: rotateX(15deg) rotateY(0deg);}
      100% { transform: rotateX(15deg) rotateY(360deg);}
    }
    .btn-3d {
      position: relative;
      background: linear-gradient(90deg, #7f5cff 70%, #45e2ff 100%);
      color: #fff;
      border-radius: 2.5rem;
      padding: 0.75rem 2.5rem;
      font-weight: bold;
      font-size: 1.25rem;
      transition: transform 0.13s, box-shadow 0.13s;
      box-shadow: 0 4px 20px #41007630, 0 2px 6px #00fff150;
      outline: none;
      border: none;
      overflow: hidden;
    }
    .btn-3d:active {
      transform: translateY(2px) scale(0.98);
      box-shadow: 0 1px 6px #265b9b60, 0 1px 3px #00fff130;
    }
    .pulse {
      animation: pulseAnim 1.8s infinite;
    }
    @keyframes pulseAnim {
      0%, 100% { box-shadow: 0 0 0 0 rgba(127,92,255,0.1);}
      50% { box-shadow: 0 0 25px 10px rgba(127,92,255,0.4);}
    }
    .sound-on {
      color: #00ffd0;
      filter: drop-shadow(0 2px 4px #00f5ff66);
      transition: color .18s;
    }
    .sound-off {
      color: #b0b8cc;
    }
    .fade-up {
      opacity: 0;
      transform: translateY(18px);
      animation: fade-up .9s .3s forwards;
    }
    @keyframes fade-up {
      to {
        opacity: 1;
        transform: none;
      }
    }
    /* Loader ring */
    .lds-ring {
      display: inline-block;
      position: relative;
      width: 60px;
      height: 60px;
      margin: 0 auto;
    }
    .lds-ring div {
      box-sizing: border-box;
      display: block;
      position: absolute;
      width: 48px;
      height: 48px;
      margin: 6px;
      border: 5px solid #7f5cff;
      border-radius: 50%;
      animation: lds-ring 1.2s cubic-bezier(.5,.25,.75,.75) infinite;
      border-color: #7f5cff transparent transparent transparent;
    }
    .lds-ring div:nth-child(1) { animation-delay: -0.45s;}
    .lds-ring div:nth-child(2) { animation-delay: -0.3s;}
    .lds-ring div:nth-child(3) { animation-delay: -0.15s;}
    @keyframes lds-ring {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
  </style>
</head>
<body class="bg-gradient-to-tr from-indigo-950 to-blue-900 min-h-screen flex flex-col">
  <!-- Header -->
  <header class="flex flex-col items-center pt-8 pb-4">
    <span class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-violet-400 via-pink-300 to-cyan-300 tracking-wide drop-shadow-lg select-none">
      <i class="fa-solid fa-shield-halved mr-2"></i>
      Com Dot KKH
    </span>
    <span class="mt-2 text-xl font-semibold text-cyan-100 tracking-wide select-none">2FA TOTP Generator</span>
    <span class="mt-1 text-sm text-cyan-200 tracking-wide select-none">Real-time code · Secure · Local</span>
  </header>

  <!-- 3D Animation Cube & Sound Toggle -->
  <div class="flex flex-col items-center py-1 fade-up">
    <div class="totp-cube mb-2">
      <div class="cube" id="cube">
        <div class="cube-face front"><i class="fa-solid fa-shield-halved"></i></div>
        <div class="cube-face back"><i class="fa-solid fa-key"></i></div>
        <div class="cube-face right"><i class="fa-solid fa-lock"></i></div>
        <div class="cube-face left"><i class="fa-solid fa-circle-check"></i></div>
        <div class="cube-face top"><i class="fa-solid fa-qrcode"></i></div>
        <div class="cube-face bottom"><i class="fa-solid fa-user-secret"></i></div>
      </div>
    </div>
    <button id="sound-toggle" class="text-2xl mt-2" title="Toggle Sound">
      <i id="sound-icon" class="fa-solid fa-volume-up sound-on"></i>
    </button>
  </div>

  <!-- Main TOTP Generator -->
  <main class="flex flex-1 flex-col items-center justify-center py-2 px-4">
    <section class="w-full max-w-lg rounded-2xl bg-gradient-to-br from-blue-900 via-indigo-900 to-cyan-700 shadow-xl bg-opacity-90 p-8 fade-up">
      <h2 class="text-2xl font-bold text-cyan-100 text-center mb-4 flex items-center justify-center gap-2">
        <i class="fa-brands fa-expeditedssl mr-1"></i>
        Your TOTP Code
      </h2>
      <div id="code-container" class="flex flex-col items-center mt-5">
        <div class="lds-ring" id="loader"><div></div><div></div><div></div><div></div></div>
        <div class="hidden flex flex-row items-center gap-3">
          <span id="totp-code" class="text-cyan-50 font-mono text-3xl md:text-4xl tracking-widest select-all pulse"></span>
          <button id="copy-btn" class="ml-1 btn-3d flex items-center text-cyan-50" title="Copy code"><i class="fa-solid fa-copy"></i></button>
        </div>
        <div class="mt-3 flex items-center gap-2">
          <i class="fa-solid fa-clock text-cyan-300"></i>
          <span id="timer" class="text-cyan-100 text-lg font-medium"></span>
        </div>
      </div>
      <div class="mt-7 text-cyan-200 text-sm flex items-center justify-center">
        <i class="fa-solid fa-shield-cat mr-2"></i>
        Your secret key never leaves this browser.
      </div>
      <div class="mt-3 text-xs text-cyan-400 flex items-center justify-center">
        <i class="fa-solid fa-book-open mr-1"></i>
        <a href="https://datatracker.ietf.org/doc/html/rfc6238" target="_blank" class="underline hover:text-cyan-200">Learn about TOTP</a>
      </div>
      <div class="mt-7 flex flex-col gap-2">
        <label for="secret" class="text-cyan-100 font-medium mb-1">Your TOTP Secret</label>
        <input id="secret" type="text" maxlength="64" autocomplete="off" class="w-full px-4 py-2 rounded-lg border border-cyan-400 focus:ring-2 focus:ring-cyan-400 focus:outline-none font-mono text-xl text-cyan-700 bg-cyan-50" placeholder="Enter your TOTP secret in base32..." spellcheck="false">
      </div>
      <div class="flex items-center justify-center mt-5">
        <button id="generate-btn" class="btn-3d flex items-center gap-2">
          <i class="fa-solid fa-fingerprint"></i>
          Generate/Refresh Code
        </button>
      </div>
    </section>
  </main>

  <footer class="mt-7 pb-7 flex flex-col items-center w-full">
    <span class="text-xs text-cyan-400 flex items-center gap-2">
      <i class="fa-solid fa-code-branch"></i> Made with <span class="text-pink-300">♥</span> by Com Dot KKH
    </span>
  </footer>

  <!-- Sound Effect -->
  <audio id="sound-effect" src="https://cdn.pixabay.com/audio/2022/10/16/audio_12ac81b9bc.mp3" preload="auto"></audio>

  <!-- TOTP Algorithm JS -->
  <script>
    /* Simple base32 decoder */
    function base32tohex(base32) {
      const base32chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";
      let bits = "", hex = "";
      base32 = base32.replace(/[^A-Z2-7]+/ig, '').toUpperCase();
      for (let i = 0; i < base32.length; i++) {
        const val = base32chars.indexOf(base32.charAt(i));
        bits += val.toString(2).padStart(5, '0');
      }
      for (let i = 0; i+4 <= bits.length; i+=4) {
        hex = hex + parseInt(bits.substr(i,4),2).toString(16);
      }
      return hex;
    }

    async function generateTOTP(secret, timestamp = Date.now()) {
      if(!secret) return '';
      const key = base32tohex(secret);
      const epoch = Math.floor(timestamp / 1000.0);
      const time = Math.floor(epoch / 30).toString(16).padStart(16, '0');
      const timeArray = [];
      for(let i = 0; i < 16; i += 2) {
        timeArray.push(parseInt(time.substr(i,2),16));
      }
      const keyBytes = [];
      for(let i = 0; i < key.length; i+=2) {
        keyBytes.push(parseInt(key.substr(i,2),16));
      }
      // Polyfill for browser subtle crypto hmac-sha1
      const cryptoKey = await window.crypto.subtle.importKey(
        "raw", new Uint8Array(keyBytes), {name: "HMAC", hash: "SHA-1"}, false, ["sign"]
      );
      const hmac = await window.crypto.subtle.sign(
        "HMAC", cryptoKey, new Uint8Array(timeArray)
      );
      const hmacResult = new Uint8Array(hmac);
      const offset = hmacResult[hmacResult.length-1] & 0xf;
      let code = ((hmacResult[offset] & 0x7f) << 24) |
                ((hmacResult[offset+1] & 0xff) << 16) |
                ((hmacResult[offset+2] & 0xff) << 8) |
                (hmacResult[offset+3] & 0xff);
      code = code % 1000000;
      return code.toString().padStart(6, '0');
    }

    let timerInterval = null, lastSecret = "";
    const secretInput = document.getElementById('secret');
    const generateBtn = document.getElementById('generate-btn');
    const codeContainer = document.getElementById('code-container');
    const codeBox = document.getElementById('totp-code');
    const loader = document.getElementById('loader');
    const timerBox = document.getElementById('timer');
    const copyBtn = document.getElementById('copy-btn');
    const audio = document.getElementById('sound-effect');
    const soundToggle = document.getElementById('sound-toggle');
    const soundIcon = document.getElementById('sound-icon');
    let soundEnabled = true;
    // Display loader initially
    function showLoader() {
      loader.classList.remove('hidden');
      loader.nextElementSibling.classList.add('hidden');
    }
    function showCode() {
      loader.classList.add('hidden');
      loader.nextElementSibling.classList.remove('hidden');
    }
    function showTimer(secs) {
      const remain = 30 - (secs % 30);
      timerBox.textContent = `Code refreshes in ${remain}s`;
      timerBox.parentNode.querySelector('i').classList.toggle('animate-pulse', remain <= 6);
    }
    async function updateTOTP(shouldPlaySound=false) {
      const secret = secretInput.value.trim();
      if (!secret) {
        showLoader();
        codeBox.textContent = "";
        timerBox.textContent = "---";
        return;
      }
      showLoader();
      setTimeout(async () => {
        try {
          const code = await generateTOTP(secret);
          codeBox.textContent = code;
          showCode();
          if (shouldPlaySound && soundEnabled) audio.play();
        } catch (err) {
          codeBox.textContent = "Error!";
        }
      }, 300);
    }

    secretInput.addEventListener('input', () => {
      // New secret entered
      updateTOTP();
    });

    function startTimer() {
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(async () => {
        const seconds = Math.floor(Date.now()/1000)%30;
        showTimer(seconds);
        if (seconds === 0) {
          // New code! Animate & sound
          await updateTOTP(true);
          codeBox.classList.add('pulse');
          setTimeout(() => codeBox.classList.remove('pulse'), 1100);
        }
      }, 1000);
    }

    generateBtn.addEventListener('click', async () => {
      await updateTOTP(true);
    });

    // Copy to clipboard
    if (copyBtn) copyBtn.addEventListener('click', () => {
      if (!codeBox.textContent || codeBox.textContent === "Error!") return;
      navigator.clipboard.writeText(codeBox.textContent);
      // play copy sound if soundEnabled
      if (soundEnabled) {
        audio.currentTime = 0;
        audio.play();
      }
      copyBtn.classList.add('animate-bounce');
      setTimeout(()=>copyBtn.classList.remove('animate-bounce'), 650);
    });

    // Sound toggle
    soundToggle.addEventListener('click', () => {
      soundEnabled = !soundEnabled;
      if (soundEnabled) {
        soundIcon.classList.remove('fa-volume-mute','sound-off');
        soundIcon.classList.add('fa-volume-up','sound-on');
      } else {
        soundIcon.classList.remove('fa-volume-up','sound-on');
        soundIcon.classList.add('fa-volume-mute','sound-off');
      }
    });

    // init page
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        showLoader();
        startTimer();
        showTimer(Math.floor(Date.now()/1000)%30);
      }, 150);
    });

  </script>
</body>
</html>

